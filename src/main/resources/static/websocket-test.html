<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - YakRooms</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .connect { background-color: #28a745; color: white; }
        .disconnect { background-color: #dc3545; color: white; }
        .test { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div>
        <button id="connectBtn" class="connect" onclick="connect()">Connect to /ws</button>
        <button id="connectBookingsBtn" class="connect" onclick="connectToBookings()">Connect to /ws/bookings</button>
        <button id="disconnectBtn" class="disconnect" onclick="disconnect()" disabled>Disconnect</button>
        <button id="testBtn" class="test" onclick="sendTestMessage()" disabled>Send Test Message</button>
    </div>
    
    <h3>Connection Log</h3>
    <div id="log" class="log"></div>
    
    <h3>Important Notes</h3>
    <ul>
        <li><strong>Correct connection:</strong> Use <code>/ws</code> endpoint</li>
        <li><strong>Incorrect connection:</strong> <code>/ws/bookings</code> will cause "Invalid SockJS path" error</li>
        <li>SockJS automatically handles internal routing and requires specific path patterns</li>
        <li>After connecting to <code>/ws</code>, you can subscribe to topics like <code>/topic/bookings</code></li>
    </ul>

    <script>
        let stompClient = null;
        let socket = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.className = type;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${className}`;
        }
        
        function updateButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('connectBookingsBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('testBtn').disabled = !connected;
        }
        
        function connect() {
            log('Attempting to connect to /ws...', 'info');
            
            try {
                // Correct connection - use /ws endpoint
                socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                
                stompClient.connect({}, function (frame) {
                    log('Successfully connected to /ws', 'connected');
                    updateStatus('Connected to /ws', 'connected');
                    updateButtons(true);
                    
                    // Subscribe to booking topics
                    stompClient.subscribe('/topic/bookings', function (message) {
                        log('Received message on /topic/bookings: ' + message.body, 'info');
                    });
                    
                    stompClient.subscribe('/topic/test', function (message) {
                        log('Received message on /topic/test: ' + message.body, 'info');
                    });
                    
                    log('Subscribed to /topic/bookings and /topic/test', 'info');
                }, function (error) {
                    log('Connection error: ' + error, 'error');
                    updateStatus('Connection failed', 'error');
                    updateButtons(false);
                });
                
            } catch (error) {
                log('Error creating connection: ' + error.message, 'error');
                updateStatus('Connection failed', 'error');
            }
        }
        
        function connectToBookings() {
            log('Attempting to connect to /ws/bookings...', 'info');
            log('This will likely cause an "Invalid SockJS path" error', 'error');
            
            try {
                // This connection will cause the SockJS path error
                socket = new SockJS('/ws/bookings');
                stompClient = Stomp.over(socket);
                
                stompClient.connect({}, function (frame) {
                    log('Unexpectedly connected to /ws/bookings', 'connected');
                    updateStatus('Connected to /ws/bookings', 'connected');
                    updateButtons(true);
                }, function (error) {
                    log('Connection error (expected): ' + error, 'error');
                    updateStatus('Connection failed - Invalid SockJS path', 'error');
                    updateButtons(false);
                });
                
            } catch (error) {
                log('Error creating connection: ' + error.message, 'error');
                updateStatus('Connection failed', 'error');
            }
        }
        
        function disconnect() {
            if (stompClient) {
                stompClient.disconnect();
                log('Disconnected from WebSocket', 'info');
                updateStatus('Disconnected', 'disconnected');
                updateButtons(false);
            }
        }
        
        function sendTestMessage() {
            if (stompClient && stompClient.connected) {
                // Send a test message to the application destination
                stompClient.send("/app/test", {}, JSON.stringify({
                    message: "Hello from WebSocket test client",
                    timestamp: new Date().toISOString()
                }));
                log('Sent test message to /app/test', 'info');
            } else {
                log('Not connected to WebSocket', 'error');
            }
        }
        
        // Initialize page
        updateStatus('Ready to connect', 'info');
        log('WebSocket test page loaded. Click "Connect to /ws" to test the correct connection.', 'info');
    </script>
</body>
</html>
